<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>Websitesi Deneme</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #spectrumContainer {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    #spectrumInfo {
      margin-top: 10px;
      font-family: monospace;
      background-color: #eee;
      padding: 10px;
      border-radius: 5px;
    }
    #spectrumImage {
      max-width: 100%;
      height: auto;
      border: 1px solid #ccc;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .button-stop {
      background-color: #f44336;
    }
    .button-stop:hover {
      background-color: #d32f2f;
    }
  </style>
</head>
<body>
  <header>
    <h1>Websitesi Deneme</h1>
    <nav>
      <a href="index.html">Ana sayfa</a>
      <a href="veriler.html">Veriler</a>
    </nav>
  </header>
  <section id="home">
    <h2>Proje Bilgileri</h2>
    <p>Otonom Araç Projesi.</p>
  </section>
  
  <!-- Kod Başlatma Bölümü -->
  <section id="control">
    <h2>Raspberry Pi Kontrolü</h2>
    <div class="controls">
      <button id="startBtn">Kod Başlat</button>
      <button id="stopBtn" class="button-stop">Kod Durdur</button>
    </div>
    <div id="statusMessage"></div>
  </section>
  
  <!-- Spektrum Görüntüleme Bölümü -->
  <section id="spectrumContainer">
    <h2>Spektrum Analizi</h2>
    <div id="spectrumDisplay">
      <img id="spectrumImage" src="" alt="Spektrum analizi görüntüsü" />
      <div id="spectrumInfo">
        <p>Tepe Frekansı: <span id="peakFreq">-</span> MHz</p>
        <p>Tepe Gücü: <span id="peakPower">-</span> dB</p>
        <p>Ortalama Güç: <span id="avgPower">-</span> dB</p>
      </div>
    </div>
  </section>
  
  <footer></footer>
  
  <script>
    // DOM elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const spectrumImage = document.getElementById('spectrumImage');
    const peakFreqEl = document.getElementById('peakFreq');
    const peakPowerEl = document.getElementById('peakPower');
    const avgPowerEl = document.getElementById('avgPower');
    const statusMessage = document.getElementById('statusMessage');
    
    // Server URL - Kesinlikle HTTP kullanın
    const serverUrl = 'http://172.20.10.2:5000';
    
    // Flag to track if updates are running
    let updatingSpectrum = false;
    
    // Function to display status messages
    function showStatus(message, isError = false) {
      statusMessage.textContent = message;
      statusMessage.style.color = isError ? 'red' : 'green';
      statusMessage.style.padding = '10px';
      statusMessage.style.marginTop = '10px';
      statusMessage.style.backgroundColor = isError ? '#ffeeee' : '#eeffee';
      statusMessage.style.border = 1px solid ${isError ? '#ffcccc' : '#ccffcc'};
      statusMessage.style.borderRadius = '4px';
    }
    
    // Function to start the code
    async function startCode() {
      startBtn.disabled = true;
      startBtn.textContent = 'Başlatılıyor…';
      
      try {
        showStatus('Raspberry Pi\'ye bağlanılıyor...');
        
        const res = await fetch(${serverUrl}/start, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          throw new Error(HTTP hata: ${res.status});
        }
        
        const data = await res.json();
        console.log('Start response:', data);
        
        // Start updating spectrum data
        showStatus('Kod başlatıldı, spektrum verisi alınıyor...');
        startSpectrumUpdates();
      } catch (err) {
        console.error('Başlatma hatası:', err);
        showStatus(Başlatma hatası: ${err.message}, true);
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = 'Kod Başlat';
      }
    }
    
    // Function to stop the code
    async function stopCode() {
      stopBtn.disabled = true;
      stopBtn.textContent = 'Durduruluyor…';
      
      try {
        const res = await fetch(${serverUrl}/stop, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          throw new Error(HTTP hata: ${res.status});
        }
        
        const data = await res.json();
        console.log('Stop response:', data);
        
        // Stop updating spectrum data
        stopSpectrumUpdates();
        showStatus('Kod durduruldu');
      } catch (err) {
        console.error('Durdurma hatası:', err);
        showStatus(Durdurma hatası: ${err.message}, true);
      } finally {
        stopBtn.disabled = false;
        stopBtn.textContent = 'Kod Durdur';
      }
    }
    
    // Function to start spectrum updates
    function startSpectrumUpdates() {
      if (!updatingSpectrum) {
        updatingSpectrum = true;
        updateSpectrumData();
        // Update spectrum image every second
        window.spectrumInterval = setInterval(updateSpectrumImage, 1000);
      }
    }
    
    // Function to stop spectrum updates
    function stopSpectrumUpdates() {
      updatingSpectrum = false;
      if (window.spectrumInterval) {
        clearInterval(window.spectrumInterval);
        window.spectrumInterval = null;
      }
    }
    
    // Function to update spectrum data
    async function updateSpectrumData() {
      if (!updatingSpectrum) return;
      
      try {
        const res = await fetch(${serverUrl}/spectrum_data, {
          method: 'GET',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          throw new Error(HTTP hata: ${res.status});
        }
        
        const data = await res.json();
        console.log('Spectrum data:', data);
        
        // Update info display
        peakFreqEl.textContent = data.peak_freq.toFixed(3);
        peakPowerEl.textContent = data.peak_power.toFixed(2);
        avgPowerEl.textContent = data.avg_power.toFixed(2);
        
        // Continue updating if still active
        if (updatingSpectrum) {
          setTimeout(updateSpectrumData, 500);
        }
      } catch (err) {
        console.error('Spektrum veri hatası:', err);
        // Retry after a delay
        if (updatingSpectrum) {
          setTimeout(updateSpectrumData, 2000);
        }
      }
    }
    
    // Function to update spectrum image
    function updateSpectrumImage() {
      if (!updatingSpectrum) return;
      
      // Use a timestamp to prevent caching
      const timestamp = new Date().getTime();
      spectrumImage.src = ${serverUrl}/spectrum_image?t=${timestamp};
      
      // Handle image load errors
      spectrumImage.onerror = () => {
        console.error('Failed to load spectrum image');
        spectrumImage.src = ''; // Clear on error
      };
    }
    
    // Event listeners
    startBtn.addEventListener('click', startCode);
    stopBtn.addEventListener('click', stopCode);
    
    // Initialize the page
    window.addEventListener('load', () => {
      // Clear any previous image
      spectrumImage.src = '';
      showStatus('Hazır. Başlatmak için "Kod Başlat" düğmesine tıklayın.');
    });
  </script>
</body>
</html>
